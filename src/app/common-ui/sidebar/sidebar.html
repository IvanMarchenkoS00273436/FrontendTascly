<div class="bento-sidebar">

    <!-- Organization Block -->
    @if ($userProfile | async; as user) {
    <div class="mb-4">
        <label class="modern-label ps-2 mb-2">Your Organization</label>

        <a [routerLink]="['/dashboard', 'organization']"
            class="organization-card d-flex align-items-center gap-3 text-decoration-none text-dark"
            style="cursor: pointer;">

            <!-- Icon Box -->
            <div class="org-icon-box flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 21h18" />
                    <path d="M5 21V7l8-4 8 4v14" />
                    <path d="M8 21v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    <path d="M10 9a2 2 0 1 1 4 0" />
                </svg>
            </div>

            <!-- Text Content -->
            <div class="flex-grow-1 overflow-hidden">
                <p class="mb-0 fw-bold text-truncate small">{{ user.organizationName }}</p>
                <p class="mb-0 text-muted small" style="font-size: 0.75rem;">Organization Overview</p>
            </div>

            <!-- Hover Arrow -->
            <div class="arrow-icon text-muted">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14" />
                    <path d="m12 5 7 7-7 7" />
                </svg>
            </div>
        </a>
    </div>

    <!-- User Profile Block -->
    <label class="modern-label ps-2 mb-2">Your Profile</label>
    <!-- Added routerLink to navigate to profile -->
    <a [routerLink]="['/dashboard', 'profile']"
        class="user-profile-card mb-4 d-flex align-items-center gap-3 text-decoration-none">
        <!-- Avatar -->
        <div class="avatar-box-small flex-shrink-0">
            {{ user.firstName.charAt(0) | uppercase }}{{ user.lastName.charAt(0) | uppercase }}
        </div>

        <!-- Info -->
        <div class="flex-grow-1 overflow-hidden" style="min-width: 0;">
            <p class="mb-0 fw-bold text-dark text-truncate small" style="line-height: 1.2;">
                {{ user.firstName }} {{ user.lastName }}
            </p>

            <p class="mb-0 text-muted text-truncate" style="font-size: 0.75rem; line-height: 1.2;">
                {{ user.userName }}
            </p>
        </div>

        <!-- Settings Icon -->
        <div class="settings-icon flex-shrink-0 text-muted">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </svg>
        </div>
    </a>
    }

    <div class="sidebar-section flex-grow-1 overflow-auto">

        <!-- Header Row with Create Button -->
        <div class="d-flex align-items-center justify-content-between pe-2 mb-2">
            <label class="modern-label ps-2 mb-0">Your Workspaces</label>
            <button class="btn-create-mini" (click)="toggleCreateInput()" title="Create Workspace">
                @if (showCreateInput) {
                <!-- Minus Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                } @else {
                <!-- Plus Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                }
            </button>
        </div>

        <!-- Create Workspace Input Row -->
        @if (showCreateInput) {
        <div class="create-workspace-box mb-3 mx-2 p-2 rounded-3 bg-light border slide-down">
            <input type="text" class="form-control form-control-sm modern-input border-0 mb-2"
                placeholder="Workspace Name" [(ngModel)]="newWorkspaceNameWS" (keydown.enter)="createWorkspace()"
                autoFocus>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-lime w-100 fw-bold py-1" (click)="createWorkspace()">
                    Create
                </button>
            </div>
        </div>
        }

        <ul class="list-unstyled d-flex flex-column gap-2 mb-0">
            <!-- Updated to use Resource API .value() -->
            @if (workspaces.value(); as workspacesList) {
            @for (ws of workspacesList; track ws.id) {
            <li>
                <!-- Workspace Toggle Button -->
                <button class="btn-sidebar-toggle" (click)="toggleWorkspace(ws.id)" [class.active]="isExpanded(ws.id)">

                    <div class="d-flex align-items-center gap-3" style="min-width: 0;">
                        <!-- Initials Box -->
                        <div class="icon-box flex-shrink-0">
                            <span class="fw-bold">{{ ws.name.charAt(0) | uppercase }}</span>
                        </div>
                        <!-- Name -->
                        <span class="fw-bold text-truncate">{{ ws.name }}</span>
                    </div>

                    <!-- Chevron -->
                    <svg [class.rotate-chevron]="isExpanded(ws.id)" class="chevron flex-shrink-0"
                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m6 9 6 6 6-6" />
                    </svg>
                </button>

                <!-- Inner Content: Projects/Tasks -->
                <div class="workspace-list-wrapper" [class.expanded]="isExpanded(ws.id)">
                    <ul class="list-unstyled mb-0 pt-2 pb-1 ps-3 ms-3 border-start border-2">
                        <li>
                            <a class="workspace-item d-flex align-items-center gap-2 small">
                                <svg class="text-secondary" xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                    <polyline points="9 22 9 12 15 12 15 22" />
                                </svg>
                                Overview
                            </a>
                        </li>
                        <li>
                            <a [routerLink]="['/dashboard', ws.id, 'members']" routerLinkActive="text-primary fw-bold"
                                class="workspace-item d-flex align-items-center gap-2 small">

                                <svg class="text-secondary" xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                    <circle cx="9" cy="7" r="4" />
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                </svg>
                                Members
                            </a>
                        </li>
                        <li>
                            <!-- Projects Row -->
                            <!-- Removed manual styles, moved logic to CSS class -->
                            <div class="workspace-item d-flex align-items-center justify-content-between gap-2 small"
                                (click)="toggleProjects(ws.id)" style="cursor: pointer;">
                                <div class="d-flex align-items-center gap-2">
                                    <svg class="text-secondary" xmlns="http://www.w3.org/2000/svg" width="14"
                                        height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect width="7" height="7" x="3" y="3" rx="1" />
                                        <rect width="7" height="7" x="14" y="3" rx="1" />
                                        <rect width="7" height="7" x="14" y="14" rx="1" />
                                        <rect width="7" height="7" x="3" y="14" rx="1" />
                                    </svg>
                                    Projects
                                </div>

                                <div class="d-flex align-items-center gap-2">
                                    <button
                                        class="btn-icon-mini text-muted p-0 border-0 bg-transparent d-flex align-items-center justify-content-center"
                                        (click)="toggleCreateProject(ws.id, $event)" title="New Project"
                                        style="width: 16px; height: 16px; border-radius: 4px;">
                                        
                                        @if (createProjectWorkspaceId() === ws.id) {
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                            </svg>
                                        } @else {
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                            </svg>
                                        }
                                    </button>

                                    <svg [class.rotate-chevron]="isProjectsExpanded(ws.id)"
                                        class="chevron-small flex-shrink-0 text-muted"
                                        xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="m6 9 6 6 6-6" />
                                    </svg>
                                </div>
                            </div>

                            <div class="workspace-list-wrapper" [class.expanded]="isProjectsExpanded(ws.id)">
                                <ul class="list-unstyled mb-0 ps-3 border-start ms-4 my-1">

                                    @if (createProjectWorkspaceId() === ws.id) {
                                    <li class="mb-2 mt-1">
                                        <div class="create-workspace-box p-2 rounded-3 bg-light border slide-down"
                                            (click)="$event.stopPropagation()">

                                            <input type="text"
                                                class="form-control form-control-sm modern-input border-0 mb-2"
                                                style="font-size: 0.8rem;" placeholder="Project Name..."
                                                [(ngModel)]="newProjectName" (keydown.enter)="createProject(ws.id)"
                                                autoFocus>

                                            <div class="d-flex justify-content-end gap-1">
                                                <button class="btn btn-sm btn-lime w-100 fw-bold py-0"
                                                    style="font-size: 0.75rem; height: 24px;"
                                                    (click)="createProject(ws.id)">
                                                    Create
                                                </button>
                                            </div>
                                        </div>
                                    </li>
                                    }

                                    @for (project of getProjects(ws.id); track project.id) {
                                        <li>
                                            <a [routerLink]="['/dashboard', 'projects', project.id]"
                                                routerLinkActive="text-primary fw-bold"
                                                class="workspace-item d-flex align-items-center gap-2 small py-1"
                                                style="font-size: 0.85rem;">
                                                <span class="text-truncate">{{ project.name }}</span>
                                            </a>
                                        </li>
                                    } @empty {
                                    <li><span class="text-muted small ps-2 py-1 d-block" style="font-size: 0.75rem;">No
                                            projects</span></li>
                                    }
                                </ul>
                            </div>
                        </li>
                        <li>
                <a [routerLink]="['/dashboard/ai-task-generator']" routerLinkActive="sidebar-nav-active"
                    class="sidebar-nav-item d-flex align-items-center gap-2 small">
                    <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2z" />
                        <path d="M12 8v4l3 3" />
                    </svg>
                    AI Task Generator
                </a>
            </li>

                    </ul>
                </div>
            </li>
            } @empty {
            <li><span class="text-muted small ps-3">No workspaces found</span></li>
            }
            }
        </ul>
    </div>
</div>