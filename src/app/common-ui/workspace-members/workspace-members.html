<div class="bento-panel position-relative">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-end mb-4 px-1">
        <div>
            <h2 class="page-title mb-1">Team</h2>
            <p class="page-subtitle mb-0">Manage workspace members.</p>
        </div>
        <button class="btn btn-lime" (click)="openAssignModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add member
        </button>
    </div>

    @if (members$ | async; as members) {
    <div class="flex-grow-1 overflow-auto">
        <div class="members-grid">

            @for (member of members; track member.id) {
            @let fName = member.firstName || member.firstName.split(' ')[0] || 'User';
            @let lName = member.lastName || member.lastName.split(' ')[1] || '';

            <div class="member-card">
                <!-- 1. Lime Avatar -->
                <div class="avatar-large">
                    {{ (fName.charAt(0) || '') | uppercase }}{{ (lName.charAt(0) || fName.charAt(1) || '') | uppercase
                    }}
                </div>

                <!-- 2. Name Block -->
                <div class="name-group">
                    <span class="first-name text-truncate" [title]="fName">{{ fName }}</span>
                    <span class="last-name text-truncate" [title]="lName">{{ lName }}</span>
                </div>

                <!-- 3. Info Block -->
                <div class="info-section">

                    <!-- Role Row -->
                    <div class="info-row">
                        <div class="info-icon">
                            @if(member.role.name) {
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="#000" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                            } @else {
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="#666" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                            }
                        </div>
                        <span class="flex-grow-1 text-start user-select-none">{{ member.role.name || 'Member' }}</span>
                    </div>

                    <!-- Email Row -->
                    <div class="info-row">
                        <div class="info-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="#666" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                <polyline points="22,6 12,13 2,6" />
                            </svg>
                        </div>
                        <span class="flex-grow-1 text-start text-truncate" [title]="member.username"
                            style="font-size: 0.85rem;">
                            {{ member.username }}
                        </span>
                    </div>

                </div>
            </div>
            } @empty {
            <div
                class="col-12 py-5 text-center text-muted d-flex flex-column align-items-center justify-content-center h-100">
                <div class="p-4 bg-light rounded-circle mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                        stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                </div>
                <p class="h4 fw-bold mb-2">No members found</p>
                <p class="lead small">This workspace is currently empty.</p>
            </div>
            }
        </div>
    </div>
    }

    <!-- ASSIGN MEMBER MODAL (Overlay) -->
    @if (isAssignModalOpen) {
    <div class="modal-overlay" (click)="closeAssignModal()">
        <div class="bento-modal slide-up" (click)="$event.stopPropagation()">
            
            <!-- Modal Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h3 class="fw-black mb-1">Invite Team Member</h3>
                    <p class="text-muted small fw-medium mb-0">Add a new user to this workspace.</p>
                </div>
                <button class="btn btn-icon-soft" (click)="closeAssignModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- User Selection -->
            <div class="mb-4">
                <label class="modern-label ps-1">Select User</label>
                <div class="position-relative">
                    <select class="form-select modern-select" [(ngModel)]="selectedUserId">
                        <option value="" disabled selected>Choose a team member...</option>
                        @for (user of allUsers$ | async; track user.userId) {
                            <option [value]="user.userId">
                                {{ user.firstName }} {{ user.lastName }} ({{ user.userName }})
                            </option>
                        }
                    </select>
                    <div class="select-chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                </div>
            </div>

            <!-- Role Selection -->
            <div class="mb-5">
                <label class="modern-label ps-1">Assign Role</label>
                <div class="d-flex flex-column gap-2">
                    @for (role of availableRoles; track role) {
                    <label class="role-option" [class.selected]="selectedRole === role">
                        <input type="radio" name="roleOptions" [value]="role" [(ngModel)]="selectedRole" class="d-none">
                        
                        <div class="d-flex align-items-center gap-3 w-100">
                            <!-- Custom Radio Circle -->
                            <div class="custom-radio">
                                <div class="dot"></div>
                            </div>
                            
                            <div class="flex-grow-1">
                                <span class="d-block fw-bold text-dark">{{ role }}</span>
                                <span class="d-block small text-muted">
                                    @if(role === 'Admin') { Full workspace control and member management. }
                                    @else if(role === 'Full-access') { Can view, create, and edit all projects. }
                                    @else { Can view and comment on assigned tasks only. }
                                </span>
                            </div>
                        </div>
                    </label>
                    }
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-3 pt-2">
                <button class="btn btn-light border fw-bold flex-grow-1 py-3" (click)="closeAssignModal()"><span class="d-block text-center">Cancel</span></button>
                <button class="btn btn-lime flex-grow-1 py-3 text-center align-items-center justify-content-center" [disabled]="!selectedUserId" (click)="assignMember()">
                    <span class="d-block text-center">Confirm Access</span>
                </button>
            </div>
        </div>
    </div>
    }
</div>